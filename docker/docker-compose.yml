version: '3.3'

services:
  web:
    container_name: rabit_web
    build:
      context: .
      dockerfile: web/Dockerfile
    tty: true
    environment:
      # webé¡¹ç›®è¿è¡Œçš„ç«¯å£
      - INDEX_WEB_PORT=8601
      # webä¸‹é¡¹ç›®ä¸­Devæ˜¯ç”¨åˆ°çš„æœåŠ¡ç«¯åœ°å€ã€é»˜è®¤ä¸ºğŸ‘‡ğŸ»ORIGINï¼Œå¦‚æœå¼€å‘æ—¶æ”¹åŠ¨äº†src/Configs.tsä¸­çš„SERVER_ROOT
      # åˆ™éœ€è¦åŒæ­¥æ›´æ–°ä¸‹æ–¹çš„ORIGIN
      - ORIGIN=http://localhost:8600
      # è¿™é‡Œåº”è¯¥è®¾ç½®ä¸ºå¤–éƒ¨ç½‘ç»œè®¿é—® serveræœåŠ¡çš„è¯·æ±‚åœ°å€
      - SERVER_ROOT=http://rabit.example.com:8600
    privileged: true
    restart: always
    networks:
      - webnet
    ports:
      # è¯¥ç«¯å£å·å¯¹åº” INDEX_WEB_PORT, åº”ä¿æŒä¸€è‡´
      - 8601:8601
    volumes:
      - ./web/main.go:/go/src/app/main.go
      - ./web/boot.sh:/volume/common/boot.sh
      #ã€SHARED DIRã€‘
      - ./web/view:/volume/common/view
      # - common:/volume/common

  server:
    container_name: rabit_server
    build:
      context: .
      dockerfile: server/Dockerfile
    environment:
      - APP_MODE=release
      - PORT=8600
      - MYSQL_USER=root
      - MYSQL_DATABASE=super_rabit
      - MYSQL_PASSWORD=xxxxxxxxx
      - MYSQL_HOST=rabit_db
      - MYSQL_PORT=3306
      #æœ€å¤§ä¿ç•™çš„ç‰ˆæœ¬æ•°é‡,é»˜è®¤ä»…ä¿ç•™ 3 ä¸ª,åç»­å‘å¸ƒæ›´æ–°éƒ½ä¼šç›´æ¥æ›¿æ¢æ‰å½“å‰ç‰ˆæœ¬
      #å½“æ•°é‡å¤§äº1æ—¶,è¶…å‡ºçš„éƒ¨åˆ†ä¼šä»ç‰ˆæœ¬åˆ—è¡¨å°¾éƒ¨å¼€å§‹å‘ä¸Šåˆ é™¤
      - MAX_RESERVE_VER=5
      #cosçš„æ°¸ä¹…keyå’Œå¯†é’¥ã€æ¨èä½¿ç”¨ä¸´æ—¶å¯†é’¥(å¾…å®Œå–„)
      - COS_SECRET_ID=xxxxxxxxxxxxxxxxxxxxxx
      - COS_SECRET_KEY=xxxxxxxxxxxxxxxxxx
      # example
      - COS_BUCKET_NAME=super_rabit_file
      # 00000000
      - COS_APP_ID=0000000000
      # ap-shanghai
      - COS_REGION=ap-shanghai
      #é…ç½®cosæ–‡ä»¶çš„CDNè®¿é—®åœ°å€ã€é…ç½®åã€webé¡¹ç›®é€šè¿‡cosæ¥å£è·å–è¯¥é…ç½®è·¯å¾„
      - COS_CDN_URL=
      - COS_RES_DIR=/distribute/app
      - VIEW_PATH=/volume/common/view
    networks:
      - webnet
    ports:
      - 8600:8600
    privileged: true
    restart: always
    tty: true
    volumes:
      - ../main.go:/go/src/super_rabit/main.go
      - ../go.mod:/go/src/super_rabit/go.mod
      - ../pkg:/go/src/super_rabit/pkg
      - ../internal:/go/src/super_rabit/internal
      - ./server/boot.sh:/go/src/super_rabit/boot.sh
      #ã€SHARED DIRã€‘
      - ./web/view:/volume/common/view
    # volumes_from:
    #   - web:rw
    depends_on:
      - db
      - web
  db:
    container_name: rabit_db
    image: mysql:8.0
    command:
      - --default_authentication_plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    restart: always
    ports:
      - 3306:3306
    networks:
      - webnet
    environment:
      MYSQL_ROOT_PASSWORD: xxxxxxxxx
      MYSQL_DATABASE: super_rabit
# volumes:
#   common:
networks:
  webnet:
